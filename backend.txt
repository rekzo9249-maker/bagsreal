# Backend Integration Guide for Bags

This guide explains how to add backend functionality to your Bags livestreaming platform.

## ğŸ”Œ Supabase Setup (Recommended)

Supabase provides real-time database, authentication, and storage - perfect for livestreaming.

### 1. Install Supabase

```bash
npm install @supabase/supabase-js @supabase/auth-helpers-nextjs
```

### 2. Create Supabase Project

1. Go to [supabase.com](https://supabase.com)
2. Create a new project
3. Get your API URL and anon key from Project Settings â†’ API

### 3. Add Environment Variables

Create `.env.local`:
```env
NEXT_PUBLIC_SUPABASE_URL=your_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
```

### 4. Create Supabase Client

Create `src/lib/supabase.ts`:
```typescript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

### 5. Database Tables

Run these SQL commands in Supabase SQL Editor:

**Streams Table:**
```sql
create table streams (
  id uuid primary key default uuid_generate_v4(),
  title text not null,
  creator_address text not null,
  creator_display_name text,
  token_address text not null,
  token_symbol text not null,
  token_name text not null,
  stream_key text not null,
  is_live boolean default false,
  viewer_count integer default 0,
  peak_viewers integer default 0,
  started_at timestamp with time zone default now(),
  ended_at timestamp with time zone,
  created_at timestamp with time zone default now()
);
```

**Chat Messages Table:**
```sql
create table chat_messages (
  id uuid primary key default uuid_generate_v4(),
  stream_id uuid references streams(id),
  user_address text not null,
  user_display_name text,
  message text not null,
  created_at timestamp with time zone default now()
);
```

**Tokens Table:**
```sql
create table tokens (
  address text primary key,
  symbol text not null,
  name text not null,
  logo_url text,
  price numeric,
  price_change_24h numeric,
  market_cap numeric,
  volume_24h numeric,
  updated_at timestamp with time zone default now()
);
```

### 6. Replace Mock Data

Update `src/data/mockStreams.ts`:

```typescript
import { supabase } from '@/lib/supabase'

export async function getLiveStreams() {
  const { data, error } = await supabase
    .from('streams')
    .select('*')
    .eq('is_live', true)
    .order('started_at', { ascending: false })
  
  if (error) throw error
  return data || []
}

export async function getStreamById(id: string) {
  const { data, error } = await supabase
    .from('streams')
    .select('*')
    .eq('id', id)
    .single()
  
  if (error) throw error
  return data
}
```

### 7. Real-time Chat

Add real-time subscriptions for chat:

```typescript
useEffect(() => {
  const channel = supabase
    .channel(`chat:${streamId}`)
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'chat_messages',
        filter: `stream_id=eq.${streamId}`,
      },
      (payload) => {
        setMessages((prev) => [...prev, payload.new as ChatMessage])
      }
    )
    .subscribe()

  return () => {
    supabase.removeChannel(channel)
  }
}, [streamId])
```

## ğŸ” Wallet Integration

### Install Solana Wallet Adapter

```bash
npm install @solana/wallet-adapter-react @solana/wallet-adapter-react-ui @solana/wallet-adapter-wallets @solana/web3.js
```

### Setup Wallet Provider

Update `src/app/layout.tsx`:

```typescript
import { WalletAdapterNetwork } from '@solana/wallet-adapter-base'
import { ConnectionProvider, WalletProvider } from '@solana/wallet-adapter-react'
import { WalletModalProvider } from '@solana/wallet-adapter-react-ui'
import { PhantomWalletAdapter } from '@solana/wallet-adapter-wallets'

const wallets = [new PhantomWalletAdapter()]

export default function RootLayout({ children }) {
  return (
    <ConnectionProvider endpoint="https://api.mainnet-beta.solana.com">
      <WalletProvider wallets={wallets} autoConnect>
        <WalletModalProvider>
          {/* Your app */}
        </WalletModalProvider>
      </WalletProvider>
    </ConnectionProvider>
  )
}
```

### Update WalletButton

Replace mock wallet in `src/components/shared/WalletButton.tsx`:

```typescript
import { useWallet } from '@solana/wallet-adapter-react'

export function WalletButton() {
  const { connected, connecting, publicKey, disconnect } = useWallet()
  
  // Use actual wallet state instead of mock
}
```

## ğŸ“¹ Streaming Server Setup

### Option 1: Use Existing Service

Services like Mux, Cloudflare Stream, or AWS MediaLive can handle streaming.

### Option 2: Self-Hosted (nginx-rtmp)

```bash
# Install nginx with RTMP module
docker run -d -p 1935:1935 -p 8080:8080 alfg/nginx-rtmp
```

Update `.env.local`:
```env
NEXT_PUBLIC_STREAM_SERVER_URL=rtmp://your-server.com/live
```

## ğŸ”‘ Token Verification

Add token verification when creating streams:

```typescript
import { Connection, PublicKey } from '@solana/web3.js'

async function verifyTokenOwnership(walletAddress: string, tokenMint: string) {
  const connection = new Connection(process.env.NEXT_PUBLIC_SOLANA_RPC_URL!)
  const wallet = new PublicKey(walletAddress)
  const mint = new PublicKey(tokenMint)
  
  // Check token accounts
  const accounts = await connection.getParsedTokenAccountsByOwner(wallet, { mint })
  
  return accounts.value.length > 0 && 
         accounts.value[0].account.data.parsed.info.tokenAmount.uiAmount > 0
}
```

## ğŸ“Š Token Price Integration

Use Jupiter or CoinGecko API for token prices:

```typescript
async function getTokenPrice(tokenAddress: string) {
  const response = await fetch(
    `https://price.jup.ag/v4/price?ids=${tokenAddress}`
  )
  const data = await response.json()
  return data.data[tokenAddress]?.price
}
```

## ğŸš€ Next Steps

1. âœ… Set up Supabase database
2. âœ… Configure environment variables
3. âœ… Integrate Solana wallet
4. âœ… Add token verification
5. âœ… Set up streaming server
6. âœ… Add real-time chat
7. âœ… Implement token price updates

## ğŸ“š Additional Resources

- [Supabase Docs](https://supabase.com/docs)
- [Solana Wallet Adapter](https://github.com/solana-labs/wallet-adapter)
- [Next.js Docs](https://nextjs.org/docs)
- [nginx-rtmp](https://github.com/arut/nginx-rtmp-module)

---

Need help? Check the README.md for more information!
